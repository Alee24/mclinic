<VirtualHost *:80>
    ServerName portal.mclinic.co.ke
    ServerAlias www.portal.mclinic.co.ke

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName portal.mclinic.co.ke
    ServerAlias www.portal.mclinic.co.ke

    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/portal.mclinic.co.ke/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/portal.mclinic.co.ke/privkey.pem
    
    # SSL Security Settings
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/mclinic-error.log
    CustomLog ${APACHE_LOG_DIR}/mclinic-access.log combined

    # Enable required modules
    # a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers

    # API Proxy - Forward /api requests to port 3434
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3434
    ProxyPassReverse /api http://localhost:3434

    # WebSocket support for API
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/api/(.*) "ws://localhost:3434/$1" [P,L]

    # Frontend Proxy - Forward all other requests to port 3034
    ProxyPass / http://localhost:3034/
    ProxyPassReverse / http://localhost:3034/

    # WebSocket support for Next.js HMR (development)
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) "ws://localhost:3034/$1" [P,L]

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Cache static assets
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>

    # Upload size limit
    LimitRequestBody 52428800
</VirtualHost>

